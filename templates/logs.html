{% extends "base.html" %}

{% block title %}Activity Logs - Ethereum Wallet Monitor{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i data-feather="activity" class="me-2"></i>
                    Live Activity Monitor
                </h2>
                <div>
                    <button id="clearLogs" class="btn btn-outline-secondary me-2">
                        <i data-feather="trash-2" class="me-1"></i>
                        Clear Logs
                    </button>
                    <button id="pauseLogs" class="btn btn-outline-primary">
                        <i data-feather="pause" class="me-1"></i>
                        Pause
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div id="connectionStatus" class="status-indicator me-2"></div>
                                <span id="connectionText">Connecting...</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <strong>Active Wallets:</strong> 
                            <span id="activeWalletCount" class="badge bg-primary">0</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Total Events:</strong> 
                            <span id="eventCount" class="badge bg-info">0</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Update:</strong> 
                            <span id="lastUpdate" class="text-muted">Never</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <strong>Total Logs:</strong> 
                            <span id="logCount" class="badge bg-dark">0</span>
                        </div>
                        <div class="col-md-9">
                            <strong>Level Stats:</strong> 
                            <span id="levelStats" class="text-muted">No events yet</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="logLevel" class="form-label">Log Level</label>
                            <select id="logLevel" class="form-select">
                                <option value="all">All Levels</option>
                                <option value="info">Info</option>
                                <option value="success">Success</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="walletFilter" class="form-label">Wallet Filter</label>
                            <select id="walletFilter" class="form-select">
                                <option value="all">All Wallets</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="manualCheck" class="form-label">Manual Actions</label>
                            <button id="manualCheckAll" class="btn btn-outline-info form-control">
                                <i data-feather="refresh-cw" class="me-1"></i>
                                Check All Wallets
                            </button>
                        </div>
                        <div class="col-md-3">
                            <label for="maxLogs" class="form-label">Max Log Entries</label>
                            <select id="maxLogs" class="form-select">
                                <option value="100">100</option>
                                <option value="500" selected>500</option>
                                <option value="1000">1000</option>
                                <option value="unlimited">Unlimited</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Display -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="terminal" class="me-2"></i>
                        Activity Log Stream
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="logContainer" class="log-container">
                        <div class="text-center py-4 text-muted">
                            <i data-feather="clock" class="mb-2" style="width: 24px; height: 24px;"></i>
                            <p>Waiting for log events...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.log-container {
    height: 600px;
    overflow-y: auto;
    background-color: #1a1a1a;
    color: #ffffff;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 14px;
    line-height: 1.4;
}

.log-entry {
    padding: 8px 16px;
    border-bottom: 1px solid #333;
    white-space: pre-wrap;
    word-break: break-all;
    display: flex;
    align-items: center;
}

.log-entry:hover {
    background-color: #2a2a2a;
}

.log-info { color: #17a2b8; }
.log-success { color: #28a745; }
.log-warning { color: #ffc107; }
.log-error { color: #dc3545; }

.log-time {
    flex-shrink: 0;
    width: 100px; /* Adjust as needed */
    margin-right: 16px;
}

.log-source {
    flex-shrink: 0;
    margin-right: 16px;
}

.log-level {
    flex-shrink: 0;
    margin-right: 16px;
    display: flex;
    align-items: center;
}

.log-icon {
    width: 16px;
    height: 16px;
}

.log-message {
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Styling for highlighted parts */
.text-primary { color: #007bff !important; }
.text-info { color: #17a2b8 !important; }
.text-muted { color: #6c7575d !important; }

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #6c757d;
    display: inline-block;
    animation: pulse 2s infinite;
}

.status-connected {
    background-color: #28a745;
}

.status-disconnected {
    background-color: #dc3545;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.card {
    border: 1px solid #333;
}

.card-header {
    background-color: #343a40;
    border-bottom: 1px solid #333;
}

.stat-item {
    text-align: center;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #fff;
}

.stat-label {
    font-size: 0.9em;
    color: #ccc;
}
</style>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
class LogMonitor {
    constructor() {
        this.socket = io();
        this.logs = [];
        this.paused = false;
        this.eventCount = 0;
        this.maxLogs = 500;
        this.activeWallets = new Set();
        this.monitoringInterval = null; // To hold the interval ID

        this.init();
    }

    init() {
        this.setupSocketListeners();
        this.setupEventListeners();
        this.updateConnectionStatus('connecting');
    }

    setupSocketListeners() {
        this.socket.on('connect', () => {
            this.updateConnectionStatus('connected');
            this.addLog('System', 'Connected to monitoring system', 'success');
            
            // Request wallet status only on logs page
            this.socket.emit('get_wallet_status');
        });

        this.socket.on('disconnect', () => {
            this.updateConnectionStatus('disconnected');
            this.addLog('System', 'Disconnected from monitoring system', 'warning');
            if (this.monitoringInterval) {
                clearInterval(this.monitoringInterval);
            }
        });

        // Handle connection errors
        this.socket.on('connect_error', (error) => {
            this.updateConnectionStatus('disconnected');
            this.addLog('System', `Connection error: ${error}`, 'error');
        });

        this.socket.on('balance_update', (data) => {
            this.activeWallets.add(data.address);
            this.addLog(
                data.address,
                `Balance updated: ${data.balance} ETH at ${new Date(data.timestamp).toLocaleTimeString()}`,
                'info'
            );
            this.updateStats();
            this.updateWalletFilter();
        });

        this.socket.on('monitoring_status', (data) => {
            const level = data.status === 'started' ? 'success' : 'warning';
            this.addLog('Monitor', data.message, level);
        });

        this.socket.on('wallet_status', (wallets) => {
            wallets.forEach(wallet => {
                this.activeWallets.add(wallet.address);
            });
            this.updateWalletFilter();
            this.updateStats();
            this.addLog('System', `Loaded ${wallets.length} active wallets`, 'info');
        });

        // Custom log events
        this.socket.on('log_event', (data) => {
            this.addLog(data.source || 'System', data.message, data.level || 'info');
        });
        
        // Wallet check results
        this.socket.on('wallet_check_result', (data) => {
            if (data.success) {
                this.addLog(data.address, 'Balance check completed', 'info');
            } else {
                this.addLog(data.address, 'Balance check failed', 'warning');
            }
        });

        // Specific handlers for block and transaction logs
        this.socket.on('block_monitor', (data) => {
            this.addLog(`Block ${data.blockNumber}`, `New block mined by ${data.miner}`, 'info');
            this.addLog('System', `Block #${data.blockNumber} processed. ${data.transactions.length} transactions found.`, 'info');
        });

        this.socket.on('transaction_monitor', (data) => {
            const formattedTx = `
                Hash: <code class="text-info">${data.hash}</code>, 
                From: <code class="text-info">${data.from}</code>, 
                To: <code class="text-info">${data.to}</code>, 
                Value: <strong>${data.value} ETH</strong>, 
                Gas Used: <strong>${data.gasUsed}</strong>
            `;
            this.addLog(`Transaction ${data.hash.slice(0, 10)}...`, formattedTx, 'success');
        });
    }

    setupEventListeners() {
        document.getElementById('clearLogs').addEventListener('click', () => {
            this.clearLogs();
        });

        document.getElementById('pauseLogs').addEventListener('click', () => {
            this.togglePause();
        });

        document.getElementById('logLevel').addEventListener('change', () => {
            this.filterLogs();
        });

        document.getElementById('walletFilter').addEventListener('change', () => {
            this.filterLogs();
        });

        document.getElementById('maxLogs').addEventListener('change', (e) => {
            this.maxLogs = e.target.value === 'unlimited' ? Infinity : parseInt(e.target.value);
            this.trimLogs();
            this.renderLogs();
        });

        document.getElementById('manualCheckAll').addEventListener('click', () => {
            this.checkAllWallets();
        });
    }

    addLog(source, message, level = 'info') {
        if (this.paused && level !== 'info') return; // Allow info logs even when paused for system messages

        const timestamp = new Date();
        const logEntry = {
            id: Date.now() + Math.random(),
            timestamp,
            source,
            message,
            level
        };

        this.logs.unshift(logEntry);
        this.eventCount++;
        this.trimLogs();
        this.renderLogs();
        this.updateStats();
    }

    trimLogs() {
        if (this.logs.length > this.maxLogs && this.maxLogs !== Infinity) {
            this.logs = this.logs.slice(0, this.maxLogs);
        }
    }

    clearLogs() {
        this.logs = [];
        this.eventCount = 0;
        this.renderLogs();
        this.updateStats();
    }

    togglePause() {
        this.paused = !this.paused;
        const button = document.getElementById('pauseLogs');
        const icon = button.querySelector('i');

        if (this.paused) {
            button.innerHTML = '<i data-feather="play" class="me-1"></i> Resume';
            button.classList.replace('btn-outline-primary', 'btn-outline-success');
        } else {
            button.innerHTML = '<i data-feather="pause" class="me-1"></i> Pause';
            button.classList.replace('btn-outline-success', 'btn-outline-primary');
        }
        feather.replace();
    }

    filterLogs() {
        this.renderLogs(); // Re-render with current filters
    }

    renderLogs() {
        const container = document.getElementById('logContainer');
        const levelFilter = document.getElementById('logLevel').value;
        const walletFilter = document.getElementById('walletFilter').value;

        let filteredLogs = this.logs;

        // Apply level filter
        if (levelFilter !== 'all') {
            filteredLogs = filteredLogs.filter(log => log.level === levelFilter);
        }

        // Apply wallet filter
        if (walletFilter !== 'all') {
            filteredLogs = filteredLogs.filter(log => log.source === walletFilter);
        }

        if (filteredLogs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i data-feather="inbox" class="mb-2" style="width: 24px; height: 24px;"></i>
                    <p>No log entries match the current filters</p>
                </div>
            `;
            feather.replace();
            return;
        }

        const html = filteredLogs.map(log => this.formatLogEntry(log)).join('');
        container.innerHTML = html;

        feather.replace(); // Re-render feather icons after updating HTML
    }

    formatLogEntry(log) {
        const levelClass = this.getLevelClass(log.level);
        const icon = this.getLevelIcon(log.level);
        const timeStr = log.timestamp.toLocaleTimeString();
        const dateStr = log.timestamp.toLocaleDateString();

        // Enhanced formatting for different message types
        let formattedMessage = log.message;

        // Highlight ETH amounts
        formattedMessage = formattedMessage.replace(/(\d+\.?\d*) ETH/g, '<strong class="text-primary">$1 ETH</strong>');

        // Highlight addresses
        formattedMessage = formattedMessage.replace(/(0x[a-fA-F0-9]{40})/g, '<code class="text-info">$1</code>');

        // Highlight block numbers
        formattedMessage = formattedMessage.replace(/#(\d+)/g, '<span class="badge bg-info">#$1</span>');

        return `
            <div class="log-entry ${levelClass}" data-level="${log.level}">
                <div class="log-time">
                    <small class="text-muted" title="${dateStr}">${timeStr}</small>
                </div>
                <div class="log-source">
                    <span class="badge bg-secondary">${this.formatSource(log.source)}</span>
                </div>
                <div class="log-level">
                    <i data-feather="${icon}" class="log-icon"></i>
                </div>
                <div class="log-message">
                    ${formattedMessage}
                </div>
            </div>
        `;
    }

    formatSource(source) {
        if (source && source.startsWith('0x')) {
            return source.slice(0, 8) + '...';
        }
        return source;
    }

    updateConnectionStatus(status) {
        const indicator = document.getElementById('connectionStatus');
        const text = document.getElementById('connectionText');

        indicator.className = `status-indicator status-${status}`;

        switch(status) {
            case 'connected':
                text.textContent = 'Connected';
                text.className = 'text-success';
                break;
            case 'disconnected':
                text.textContent = 'Disconnected';
                text.className = 'text-danger';
                break;
            case 'connecting':
                text.textContent = 'Connecting...';
                text.className = 'text-warning';
                break;
        }
    }

    updateStats() {
        document.getElementById('activeWalletCount').textContent = this.activeWallets.size;
        document.getElementById('eventCount').textContent = this.eventCount;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        document.getElementById('logCount').textContent = this.logs.length; // Total logs in memory

        // Count events by level
        const levelCounts = {};
        this.logs.forEach(log => {
            levelCounts[log.level] = (levelCounts[log.level] || 0) + 1;
        });

        const statsText = Object.entries(levelCounts)
            .map(([level, count]) => `${level}: ${count}`)
            .join(', ');

        document.getElementById('levelStats').textContent = statsText || 'No events yet';
    }

    updateWalletFilter() {
        const select = document.getElementById('walletFilter');
        const currentValue = select.value;

        // Clear existing options except "All"
        select.innerHTML = '<option value="all">All Wallets</option>';

        // Add wallet options
        Array.from(this.activeWallets).sort().forEach(address => {
            const shortAddress = this.formatSource(address);
            const option = document.createElement('option');
            option.value = address;
            option.textContent = shortAddress;
            select.appendChild(option);
        });

        // Add system sources
        ['System', 'Monitor'].forEach(source => {
            const option = document.createElement('option');
            option.value = source;
            option.textContent = source;
            select.appendChild(option);
        });

        // Restore previous selection if it still exists, otherwise default to 'all'
        if (Array.from(this.activeWallets).includes(currentValue) || currentValue === 'System' || currentValue === 'Monitor') {
            select.value = currentValue;
        } else {
            select.value = 'all';
        }
    }

    // Manual wallet check only - no automatic periodic checks
    checkWalletManually(address) {
        if (this.socket && this.socket.connected) {
            this.socket.emit('check_wallet', { address: address });
            this.addLog('System', `Manual check requested for ${address}`, 'info');
        }
    }

    checkAllWallets() {
        if (this.activeWallets.size === 0) {
            this.addLog('System', 'No active wallets to check', 'warning');
            return;
        }

        this.addLog('System', `Checking ${this.activeWallets.size} wallets...`, 'info');
        this.activeWallets.forEach(address => {
            this.checkWalletManually(address);
        });
    }

    // Helper methods for log levels
    getLevelClass(level) {
        switch(level) {
            case 'success': return 'log-success';
            case 'warning': return 'log-warning';
            case 'error': return 'log-error';
            case 'info':
            default: return 'log-info';
        }
    }

    getLevelIcon(level) {
        switch(level) {
            case 'success': return 'check-circle';
            case 'warning': return 'alert-triangle';
            case 'error': return 'x-octagon';
            case 'info':
            default: return 'info';
        }
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.logMonitor = new LogMonitor();
    feather.replace();
});
</script>
{% endblock %}